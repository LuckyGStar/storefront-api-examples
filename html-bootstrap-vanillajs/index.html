<!doctype html>
<html>
    <head>
        <!-- Standard Bootstrap head content and CSS -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <title>Static Site GraphQL Storefront API Example</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    </head>
    <body>
      <div class="container-fluid">
        <h1 class="display-4" id="main-title">Bootstrap + Vanilla JS Storefront API Example</h1>
        <!-- Getting started content, will be hidden upon success of an API request -->
        <div id="getting-started">
          <p class="lead">This example shows how a static HTML site can be used to render dynamic product information using BigCommerce's GraphQL Storefront API. Product IDs and the GraphQL authentication details are accepted as URL parameters. View the source of this example <a href="https://github.com/bigcommerce/storefront-api-examples/blob/master/html-bootstrap-vanillajs/index.html">here.</a></p>
          <p>Parameters should be populated like this:</p>
          <code id="page-url"></code><code>?store_hash=<var>&lt;Your Store Hash&gt;</var>&product_ids=<var>&lt;(Optional) CSV list of product IDs to render&gt;</var>&token=<var>&lt;Your GraphQL Token&gt;</var></code>
          <p>Be sure to <a href="https://developer.bigcommerce.com/api-reference/storefront/storefront-token-api/storefront-api-auth/createtoken" target="_blank">create a token</a> valid for this page's origin: <code id="page-origin"></code><p>

          <p>To just see this page working with data from a sample store, <a href="?store_hash=jcngnmnbfy&token=eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJlYXQiOjIwMDAwMDAwMDAsInN1Yl90eXBlIjoyLCJ0b2tlbl90eXBlIjoxLCJjb3JzIjpbImh0dHBzOi8vYmlnY29tbWVyY2UuZ2l0aHViLmlvIl0sImNpZCI6MSwiaWF0IjoxNTY5NzkxNjk1LCJzdWIiOiI3bGp3YzR3d2J6d284NG9rZ2N6cnBzZzN4bGFicDNkIiwic2lkIjo5OTkzMzE3ODQsImlzcyI6IkJDIn0.oZ8kz7thdpDpLDguig-mP3y_ZBudv-kYq-Xufv1g9giX8XuaVj419zpYvRBS4yGP1Vq7jOa3SeaDWgevlNgegg">click here.</a></p>

          <div class="d-flex align-items-center" id="loading-message" style="display: none;">
            <strong>Loading...</strong>
            <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
          </div>
        </div>

        <!-- Main product listing element, to be filled out with product data from the API -->
        <div class="card-group" id="product-listing">
        </div>
      </div>

        <script>
        const pageUrl = new URL(window.location);
        const searchParams = pageUrl.searchParams;

        // Inject the current page origin into the getting started text
        document.getElementById("page-origin").innerHTML = pageUrl.origin;

        //
        // Utility functions for rendering
        //

        // Based on the browser locale, provide a localized price
        function formatLocalizedPrice (price) {
            return new Intl.NumberFormat(navigator.language, {style: 'currency', currency: price.currencyCode}).format(price.value);
        }

        // Render the price component from the supplied prices
        function renderPrice(prices) {
            return `<span class="card-text text-muted">(${prices.retailPrice ? `<del><span class="font-italic">${formatLocalizedPrice(prices.price)}</span></del>` : ''} ${formatLocalizedPrice(prices.price)})</span>`
        }

        // Create a srcset string for responsive images
        function renderSrcset(image) {
            return `${image.img100px} 100w, ${image.img250px} 250w, ${image.img500px} 500w, ${image.img1000px} 1000w, ${image.img1500px} 1500w`
        }


        // Function to strip HTML from product descriptions, leaving just the text
        function stripHtml(html){
           var doc = new DOMParser().parseFromString(html, 'text/html');
           return doc.body.textContent || "";
        }

        //
        // Page rendering logic
        //
        function renderPage(data) {
            // Set up the add-to-cart-url format
            const addToCartURLFormat = `${data.site.settings.url.vanityUrl}/cart.php?action=add&product_id=`
            // Render the HTML for the product listing by looping over each product in the response
            document.getElementById('product-listing').innerHTML = `${data.site.products.edges.map(node => renderProduct(node.product, addToCartURLFormat)).reduce((productsHtml, productHtml) => productsHtml += productHtml)}`;
        }

        //
        // Rendering logic for each product
        //
        function renderProduct(product, addToCartURLFormat) {
            // Render the product into a bootstrap "card"
            return `
                <div class="card" style="min-width: 25%;">
                ${product.defaultImage ? `<img class="card-img-top" style="min-height: 25%; object-fit: contain;" src="${product.defaultImage.img1000px}" srcset="${renderSrcset(product.defaultImage)}">` : ''
                 }
                <div class="card-body">
                  <h5 class="card-title">${product.name} ${renderPrice(product.prices)}</h5>
                  <p class="card-text text-truncate">${stripHtml(product.description)}</p>
                  
                  <a href="${addToCartURLFormat}${product.entityId}" class="btn btn-primary">Add to cart</a>
                </div>
              </div>`
        }

        function getProductAndSiteInfo(params) {
            // Use the store's canonical URL which should always resolve
            const graphQLUrl = `https://store-${params.store_hash}.mybigcommerce.com/graphql`;

            // Fetch data from the GraphQL Storefront API
            // If specific product IDs were supplied, fetch them, else just get the first few products

            return fetch(graphQLUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json',
                       'Authorization': `Bearer ${params.token}`},
              body: JSON.stringify({ query: `query StaticSiteExample {
                  site {
                    products${params.product_ids ? `(entityIds:[${params.product_ids}])` : ''} {
                      edges {
                        product: node {
                          ...ProductFields
                        }
                      }
                    }
                    settings {
                      storeName
                      url {
                        vanityUrl
                      }
                    }
                  }
                }

                fragment ProductFields on Product {
                  id
                  entityId
                  name
                  sku
                  path
                  description
                  defaultImage {
                    img100px: url(width: 100)
                    img250px: url(width: 250)
                    img500px: url(width: 500)
                    img1000px: url(width: 1000)
                    img1500px: url(width: 1500)
                    altText
                  }
                  prices {
                    price {
                      value
                      currencyCode
                    }
                    retailPrice {
                      value
                      currencyCode
                    }
                  }
                }` }),
            }).then(res => res.json()).then(res => res.data);
        }

        // Set up default params
        let params = {
            store_hash: null,
            product_ids: null,
            token: null
        };

        // Fill in supplied URL params
        Object.keys(params).forEach(function (key) {
            if (searchParams.get(key)) {
                params[key] = searchParams.get(key);
            }
        });

        // Check for required parameters, throw an error if they're not found
        if (!(params.store_hash && params.token)) {
            throw new Error('At least one of the required URL parameters (Store Hash, Token) was not supplied or was invalid');
        } else {
            // It seems like the required parameters were supplied, try to load the product data from the Storefront API
            document.getElementById('loading-message').style.display = 'block';
            getProductAndSiteInfo(params).then(data => {
                // With our data loaded, try to render the product listing
                renderPage(data);

                // Set the header to the name of the store
                document.getElementById('main-title').innerHTML = `${data.site.settings.storeName}`

                // Remove the getting started content and the loading messgae
                document.getElementById('getting-started').style.display = 'none';
                document.getElementById('loading-message').style.display = 'none';
            }).catch(e => {
              // Some error was encountered, most likely a problem with getting an API response - possibly bad credentials, if this is an HTTP 401
              console.log('Encountered an error:');
              console.error(e);
              document.getElementById('loading-message').innerHTML = `Problem loading data from the API: ${e}. Check the browser console for more details.`
            });
        }
        </script>

        <!-- Standard Bootstrap scripts -->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    </body>
</html>
